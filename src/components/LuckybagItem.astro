---
import { getImage } from 'astro:assets';
import Button from './Button.astro';
import {
  isImageMetadata,
  type ImageSource,
  applyBaseUrlToImageResult,
  applyBaseUrl,
} from '../utils/image';

interface Props {
  image: ImageSource;
  title: string;
  price: string;
  contents: Array<{ name: string; quantity: string }>;
  buttonHref: string;
  reverse?: boolean;
}

const {
  image,
  title,
  price,
  contents,
  buttonHref,
  reverse = false,
} = Astro.props;

// If ImageMetadata, use getImage() to optimize and apply base URL
// If string path, apply base URL directly
let optimizedImage: { src: string; width?: number; height?: number } | null = null;
if (isImageMetadata(image)) {
  const result = await getImage({ src: image.src });
  optimizedImage = applyBaseUrlToImageResult({
    src: result.src,
    width: image.width || image.src.width,
    height: image.height || image.src.height,
  });
}

const leftContents = contents.slice(0, Math.ceil(contents.length / 2));
const rightContents = contents.slice(Math.ceil(contents.length / 2));
---

<article class="c-luckybag-item" data-reverse={reverse ? 'true' : undefined}>
  <div class='c-luckybag-item__image-wrapper'>
    {
      optimizedImage ? (
        <img
          src={optimizedImage.src}
          alt={image.alt}
          class='c-luckybag-item__image'
          width={optimizedImage.width || 400}
          height={optimizedImage.height || 300}
          loading='lazy'
        />
      ) : (
        <img
          src={applyBaseUrl(image.src)}
          alt={image.alt}
          class='c-luckybag-item__image'
          width={image.width || 400}
          height={image.height || 300}
          loading='lazy'
        />
      )
    }
  </div>
  <div class='c-luckybag-item__info'>
    <header class='c-luckybag-item__info-header'>
      <div class='c-luckybag-item__price'>
        <span class='c-luckybag-item__price-yen'>¥</span>
        <span class='c-luckybag-item__price-value'>{price}</span>
        <span class='c-luckybag-item__price-unit'> (税込)</span>
      </div>
      <h3 class='c-luckybag-item__title'>{title}</h3>
    </header>
    <div class='c-luckybag-item__contents'>
      <div class='c-luckybag-item__contents-column'>
        {
          leftContents.map((content) => (
            <div class='c-luckybag-item__content'>
              <img
                src={applyBaseUrl('/assets/images/svg/hana.svg')}
                alt=''
                class='c-luckybag-item__content-icon'
                aria-hidden='true'
                width='16'
                height='16'
              />
              <span class='c-luckybag-item__content-text'>
                {content.name}×{content.quantity}
              </span>
            </div>
          ))
        }
      </div>
      <div class='c-luckybag-item__contents-column'>
        {
          rightContents.map((content) => (
            <div class='c-luckybag-item__content'>
              <img
                src={applyBaseUrl('/assets/images/svg/hana.svg')}
                alt=''
                class='c-luckybag-item__content-icon'
                aria-hidden='true'
                width='16'
                height='16'
              />
              <span class='c-luckybag-item__content-text'>
                {content.name}×{content.quantity}
              </span>
            </div>
          ))
        }
      </div>
    </div>
    <div class='c-luckybag-item__button-wrapper'>
      <Button href={buttonHref} variant='secondary' />
    </div>
  </div>
</article>
